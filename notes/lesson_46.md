# Lesson 46. Контекстные процессоры. Собственные фильтры и теги шаблона. Переменные User, Requst, Система Messages

## Контекстные процессоры

Контекстные процессоры - это функции, которые возвращают словарь, добавляющий переменные в контекст шаблона. Они позволяют передавать данные во все шаблоны проекта без необходимости добавлять их в каждое представление.

Определили в Джанго приложении `core` файл `context_processors.py`, в котором создали функцию `menu_context`, возвращающую список словарей с названиями и URL-адресами пунктов меню. Затем добавили этот процессор в настройки проекта, чтобы он был доступен во всех шаблонах.

## Собственные фильтры шаблона

Фильтры шаблона - это функции, которые принимают значение и возвращают его в измененном виде. Они позволяют форматировать данные перед их отображением в шаблонах.

Нам надо обязательно создать пакет `templatetags` в приложении `core`, чтобы иметь возможность использовать собственные фильтры и теги. В этом пакете создаем файл `__init__.py`, чтобы он стал пакетом, и файл `price_extras.py`, в котором определяем собственные фильтры.

Код фильтра `price_extras.py`:

```python
from django import template

register = template.Library()

@register.filter(name='format_price')
def format_price(value, currency='₽'):
    """Форматирует цену добавляя знак рубля"""
    # Преобразуем значение в число, если оно пришло строкой
    try:
        numeric_value = float(value)
        formatted_number = '{:,.0f}'.format(numeric_value).replace(',', ' ')
        # Добавляем символ рубля
        return f"{formatted_number} {currency}"
    except (ValueError, TypeError):
        # Если не удалось преобразовать в число, возвращаем исходное значение
        return value
```

Пример использования фильтра в шаблоне:

```html
{{ price|format_price }}

Или с параметром:

{{ price|format_price:"$" }}
```


### Собственные фильтры шаблона (рекомендации)

Учитывая ваши данные о барбершопе, вот какие фильтры будут действительно полезны и наглядны:

1. **Фильтр форматирования цены услуг** - превращает число 1500 в "1 500 ₽". Очень наглядно для страницы с прайс-листом и на деталях заказа.

2. **Фильтр статуса заказа** - преобразует текстовые значения статуса заказа в понятные пользователю фразы с соответствующим классом стиля. Например, "pending" становится "Ожидает подтверждения" с классом "badge bg-warning".

3. **Фильтр для работы с хобби** - учитывая, что у ваших сотрудников есть список хобби (как видно из класса Employee), можно создать фильтр, который превращает список хобби в строку через запятую или более красивое форматирование.

### Собственные теги шаблона (рекомендации)

Для контекста барбершопа отлично подойдут:

1. **Простой тег `masters_count`** - возвращает количество активных мастеров. В шаблоне просто пишем `{% masters_count %}` и получаем число. Это намного наглядней для понимания, чем сложные фильтры.

2. **Тег с параметрами `available_slots_for_date`** - принимает дату и выводит количество свободных слотов для записи в этот день. Например: `{% available_slots_for_date "2025-04-15" %}`.

3. **Инклюзивный тег `show_master_card`** - сложный тег с включением, который генерирует красивую карточку мастера с фото, именем и рейтингом. Использование: `{% show_master_card master_id %}...Дополнительная информация...{% endshow_master_card %}`.

### Контекстный процессор (рекомендации)

Учитывая ваш проект, я бы рекомендовал создать контекстный процессор, который добавляет такую информацию:

1. **Информация о барбершопе** - название, адрес, часы работы, контакты. Это позволит отображать эту информацию в футере или хедере без дублирования кода в каждом представлении.

2. **Текущие акции** - список активных акций, которые должны быть видны на каждой странице сайта (например, в боковой панели).

3. **Навигационное меню** - как вы и предлагали, это отличный случай для контекстного процессора. Меню может включать основные разделы сайта и подсвечивать текущий активный раздел.

4. **Количество непрочитанных сообщений/уведомлений** - если вы планируете добавить личный кабинет, это будет полезная информация для отображения в хедере.

Такой подход поможет студентам понять практическую ценность контекстных процессоров - они позволяют избежать дублирования кода при передаче одних и тех же данных во многих представлениях.

Особое внимание обратите на то, как объяснять процесс создания директорий `templatetags` и пакетной инициализации - это часто вызывает затруднения у начинающих.