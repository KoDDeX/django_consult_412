# Lesson 65. Восстановление пароля через email

## Маршруты для сброса пароля

### Маршрут авторизации `users/login/`

Форма для входа на сайт. Если забыли пароль, то можно восстановить его через email - надо нажать кнопку "забыли пароль?"

`users/login/` - страница входа
`LoginView` - класс, который обрабатывает запросы на вход (служебный)
`AuthenticationForm` - форма для входа
`login.html` - шаблон для страницы входа
`UserLoginView` - класс, который обрабатывает запросы на вход наследуется от `LoginView`

Добавили ссылку на восстановление пароля в шаблоне `login.html`

```html
<p class="text-center">
            Забыли пароль? <a href="{% url 'users:password_reset' %}">Восстановить</a>
        </p>
```

### Маршрут для сброса пароля `users/password-reset/`

Форма для сброса пароля. Надо ввести email, на который будет отправлена ссылка для сброса пароля.

`users/password-reset/` - страница сброса пароля
`PasswordResetView` - класс, который обрабатывает запросы на сброс пароля (сллужебный)
`PasswordResetForm` - форма для сброса пароля (сллужебный)
`password_reset_form.html` - шаблон для страницы сброса пароля
`name='password_reset'` - имя маршрута для сброса пароля
`CustomPasswordResetView` - класс, который обрабатывает запросы на сброс пароля наследуется от `PasswordResetView`
`CustomPasswordResetForm` - форма для сброса пароля наследуется от `PasswordResetForm`

```python
class CustomPasswordResetForm(PasswordResetForm):
    """Кастомная форма для сброса пароля."""
    def __init__(self, *args, **kwargs):
        """Инициализация формы сброса пароля: настройка полей."""
        super().__init__(*args, **kwargs)
        # Кастомизация поля email
        self.fields['email'].widget.attrs.update({
            'class': 'form-control mb-2',
            'placeholder': 'Email'
        })
```


### Маршрут для сброса пароля по ссылке `password-reset/done/`

На этом этапе происходит 2 действия. Фоном отравляется письмо с ссылкой на сброс пароля. А пользователю показывается страница с сообщением об отправке письма.

`password_reset_email.html` - шаблон для письма с ссылкой на сброс пароля (Указывается в `CustomPasswordResetView`)
`password_reset_done.html` - шаблон для страницы с сообщением об отправке письма
`CustomPasswordResetDoneView` - класс, который обрабатывает запросы на сброс пароля наследуется от `PasswordResetDoneView`

`{{ protocol }}://{{ domain }}{% url 'users:password_reset_confirm' uidb64=uid token=token %}`
То как выглядит ссылка в письме. Это важно. Django не ложит эту ссылку в переменные шаблона сам.
Мы должны ее сделать.

```python
class CustomPasswordResetDoneView(PasswordResetDoneView):
    """Кастомная реализация подтверждения сброса пароля."""
    template_name = 'users/password_done.html'
```

### Маршрут по которому пользователь переходит по ссылке из письма `reset/<uidb64>/<token>/`

`users/reset/<uidb64>/<token>/` - страница сброса пароля содержит форму для сброса пароля
`password_reset_confirm.html` - шаблон для страницы сброса пароля содержит форму для сброса пароля
`CustomPasswordResetConfirmView` - класс, который обрабатывает запросы на сброс пароля наследуется от `PasswordResetConfirmView`
`CustomSetPasswordForm` - форма для сброса пароля наследуется от `SetPasswordForm`

`uidb64`: Это закодированный идентификатор пользователя. Он представляет собой уникальный идентификатор пользователя, который был закодирован в Base64. Этот идентификатор позволяет системе понять, какой именно пользователь запрашивает сброс пароля. Кодирование в Base64 используется для того, чтобы скрыть реальный идентификатор пользователя и сделать его менее предсказуемым.

`token`: Это токен, который используется для подтверждения запроса на сброс пароля. Токен генерируется системой и отправляется пользова` Это временный токен, который генерируется для подтверждения запроса на сброс пароля. Токен используется для проверки подлинности запроса и гарантирует, что ссылка на сброс пароля действительна и не была подделана. Токен имеет ограниченный срок действия и может быть использован только один раз.

Django хранит данные, связанные с процессом сброса пароля, в базе данных. Основные данные, которые хранятся, это токены для сброса пароля. Эти токены хранятся в таблице, связанной с моделью `PasswordResetToken`, которая является частью приложения `django.contrib.auth.`
`
В частности, информация о токенах для сброса пароля сохраняется в таблице `django_admin_log`, если вы используете стандартные механизмы Django для сброса пароля. Однако, если вы используете кастомные механизмы или сторонние библиотеки, то структура может отличаться.


Итого

• Восстановление пароля (забыл пароль):

PasswordResetView → (письмо) → PasswordResetConfirmView + SetPasswordForm (2 поля).

• Смена пароля в личном кабинете:

PasswordChangeView (+ PasswordChangeForm / UserPasswordChangeForm) — требует старый пароль.

Таким образом, PasswordResetConfirmView и PasswordChangeView решают схожую задачу (установить новый пароль), но для разных сценариев и с разными формами:

SetPasswordForm — без старого пароля, PasswordChangeForm — со старым паролем.

### Маршрут для смены пароля `reset/done/`
`users/reset/done/` - страница с сообщением об успешном сбросе пароля
`password_reset_complete.html` - шаблон для страницы с сообщением об успешном сбросе пароля
`CustomPasswordResetCompleteView` - клас с который обрабатывает запросы на сброс пароля наследуется от `PasswordResetCompleteView`


## Настройка `SMTP` сервера Яндекс


Для настройки SMTP сервера Яндекс для отправки электронных писем из Django, выполните следующие шаги. Это позволит вашему приложению использовать Яндекс.Почту для отправки уведомлений и других сообщений пользователям.

### Шаг 1: Настройка доступа к почтовому ящику на Яндексе

1. **Вход в почтовый ящик**:
   - Откройте [https://mail.yandex.ru/](https://mail.yandex.ru/) и войдите в ваш почтовый ящик.

2. **Доступ к настройкам**:
   - Перейдите в раздел "Настройки", который находится обычно в верхней панели.

3. **Почтовые программы**:
   - В разделе "Все настройки" найдите категорию "Почтовые программы".
   - Активируйте опции, связанные с доступом почтовых клиентов к почтовому ящику через IMAP, установив необходимые галочки.

4. **Генерация пароля для приложения**:
   - В разделе "Управление аккаунтом" перейдите в "Безопасность" -> "Доступы и пароли".
   - Выберите "Пароли приложений", выберите тип приложения "Почта", и следуйте инструкциям для создания пароля приложения. Этот пароль будет использоваться вместо вашего обычного пароля для доступа к SMTP.

![[Pasted image 20250217204920.png]]

![[Pasted image 20250619231343.png]]

![[Pasted image 20250619231400.png]]


### Шаг 2: Настройка Django для использования SMTP Яндекса

1. **Изменение настроек почтового сервера**:
   - В файле `settings.py` вашего Django проекта найдите и закомментируйте текущую настройку `EMAIL_BACKEND`, если она настроена на вывод в консоль:
     ```python
     # EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'
     ```

2. **Установка параметров SMTP**:
   - Укажите следующие настройки для использования Яндекс SMTP сервера:
```python
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.yandex.ru'
EMAIL_PORT = 465
EMAIL_HOST_USER = 'ваш_яндекс_почтовый_ящик'
EMAIL_HOST_PASSWORD = 'пароль_приложения'
EMAIL_USE_SSL = True
DEFAULT_FROM_EMAIL = 'адрес_отправителя'
SERVER_EMAIL = 'адрес_отправителя'
EMAIL_ADMIN = 'адрес_для_административных_уведомлений'
```

### Шаг 3: Тестирование отправки почты

После настройки параметров вы можете протестировать отправку почты с помощью Django shell:

```bash
python manage.py shell
```

В shell выполните следующие команды:

```python
from django.core.mail import send_mail

send_mail(
    'Тестовое сообщение',
    'Это тестовое сообщение, отправленное из Django через Яндекс SMTP.',
    'ваш_яндекс_почтовый_ящик',  # Используйте DEFAULT_FROM_EMAIL, если он установлен
    ['получатель@пример.com'],
    fail_silently=False,
)
```

Это отправит тестовое письмо на указанный адрес электронной почты, что позволит вам убедиться, что настройки SMTP сервера Яндекс работают корректно.

Или проведите ручное тестирование отправки почты через веб-интерфейс вашего приложения.